{% extends "base.html" %}
{% load static %}

{% block 'title' %}Criar novo treino{% endblock %}

{% block 'head' %}
<style>

/* ======== CENTRALIZAR AS TABS ======== */
.nav-pills {
    display: flex !important;
    justify-content: center !important;
    gap: 10px;
}

/* ======== CORRIGIR O BUG DO LAYOUT ======== */
.tab-content {
    width: 100%;
}

.tab-pane {
    width: 100%;
    display: none; /* bootstrap controla */
}

.tab-pane.show.active {
    display: block; /* garante que só a aba ativa aparece */
}

/* ======== GRID DE MÚSCULOS ======== */
.musculos {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    max-width: 900px;
    margin: 0 auto; /* centralizado */
}

/* ======== CARDS ======== */
.card-musculo {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    border-radius: 10px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: 0.2s;
}

.card-musculo img {
    width: 150px;
}

.card-musculo:hover {
    transform: scale(1.05);
}

.card-musculo.selecionado {
    border: 2px solid #4CAF50; 
    background: rgba(76, 175, 80, 0.15);
}

.card-musculo p {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 10px;
}

</style>
{% endblock %}

{% block 'body'%}
<h1 class="text-center">Criar novo treino semanal</h1>

<div class="dias-container">

  <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    {% for d in dias %}        
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if forloop.first %}active{% endif %}" 
                    id="pills-{{ d.id }}-tab" 
                    data-bs-toggle="pill" 
                    data-bs-target="#pills-{{ d.id }}" 
                    type="button" role="tab" 
                    aria-controls="pills-{{ d.id }}" 
                    aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                {{ d.nome }}
            </button>
        </li>
    {% endfor %}
  </ul>

  <div class="tab-content conteudo mt-4" id="pills-tabContent">
    {% for d in dias %}
        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
             id="pills-{{ d.id }}" 
             role="tabpanel">

            <div class="musculos">
                {% for m in musculos %}
                    <div class="card-musculo"
                         onclick="toggleMusculo('{{ m.id }}', this)"
                         data-musculo="{{ m.id }}">
                         
                        <p>{{ m.nome }}</p>
                        {% if m.imagem %}
                            <img src="{{ m.imagem.url }}" alt="{{ m.nome }}">
                        {% else %}
                            <img src="{% static 'img/default.png' %}" alt="{{ m.nome }}">
                        {% endif %}
                    </div>
                {% empty %}
                    <p>Nenhum músculo cadastrado.</p>
                {% endfor %}
            </div>

        </div>
    {% endfor %}
  </div>    

</div>

<div class="text-center mt-4">
    <button class="btn btn-success" onclick="confirmarDias()">Salvar Treino</button>
</div>

<script>
let musculosSelecionadosPorDia = {};

function toggleMusculo(musculoId, elemento) {
    const activeTab = document.querySelector('.tab-pane.show.active');
    if (!activeTab) return;

    const diaId = activeTab.id.replace('pills-','');
    musculoId = String(musculoId);

    if (!musculosSelecionadosPorDia[diaId]) 
        musculosSelecionadosPorDia[diaId] = new Set();

    if (musculosSelecionadosPorDia[diaId].has(musculoId)) {
        musculosSelecionadosPorDia[diaId].delete(musculoId);
        elemento.classList.remove('selecionado');
    } else {
        musculosSelecionadosPorDia[diaId].add(musculoId);
        elemento.classList.add('selecionado');
    }
}

function confirmarDias() {
    const parts = [];

    for (const dia in musculosSelecionadosPorDia) {
        const ids = Array.from(musculosSelecionadosPorDia[dia]);
        if (ids.length > 0) {
            parts.push(`${dia}:${ids.join(',')}`);
        }
    }

    const selecao = parts.join(';');

    if (!selecao) {
        alert("Selecione pelo menos 1 músculo para 1 dia.");
        return;
    }

    // envia SOMENTE selecao
    const url = "{% url 'confirmar_treino' %}?selecao=" + encodeURIComponent(selecao);
    window.location.href = url;
}

</script>

{% endblock %}
