{% extends "base.html" %}
{% load static %}
{% block title %}Editar Semana{% endblock %}

{% block body %}
<div class="container mt-4">
    <h3>Semana {{ semana.numero_semana }}/{{ semana.ano }}</h3>
    <p>{{ semana.inicio }} → {{ semana.fim }}</p>

    <form method="post" id="formSemana">
        {% csrf_token %}

        <!-- Peso da semana -->
        <div class="mb-3">
            <label for="peso">Peso (kg)</label>
            <input type="number" id="peso" name="peso" min="1" class="form-control" value="{{ semana.peso|default:'' }}">
        </div>

        <!-- TABS por dia -->
        <div>
            <ul id="tabs" style="list-style:none; display:flex; gap:8px; padding:0;">
                {% for dia in dias %}
                <li style="cursor:pointer; padding:6px 10px; border:1px solid #ccc; border-radius:4px;" 
                    data-dia="{{ dia.id }}" onclick="mostrarTab({{ dia.id }}, this)">
                    {{ dia.nome }}
                </li>
                {% endfor %}
            </ul>

            <div style="margin-top:16px;">
                {% for dia in dias %}
                <div class="tab-content" id="tab-{{ dia.id }}" style="display: none;">
                    <h5>{{ dia.nome }}</h5>

                    <p>Selecione os músculos para {{ dia.nome }}:</p>

                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        {% for m in musculos %}
                        {% comment %}
                           queremos saber se este músculo já está selecionado nesse TreinoDia
                        {% endcomment %}
                        {% with td=treino_dias|dict_get:dia.id %}
                            {% if td %}
                                {% if m in td.musculos.all %}
                                    {% set checked=True %}
                                {% else %}
                                    {% set checked=False %}
                                {% endif %}
                            {% else %}
                                {% set checked=False %}
                            {% endif %}
                        {% endwith %}

                        <label style="border:1px solid #ddd; padding:6px 8px; border-radius:6px;">
                            <input type="checkbox" class="musculo-checkbox" data-dia="{{ dia.id }}" value="{{ m.id }}" 
                                {% if m in treino_dias|dict_get:dia.id.musculos.all %} checked {% endif %}>
                            {{ m.nome }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- hidden fields serão preenchidos pelo JS antes do submit -->
        <div id="hidden-fields"></div>

        <div class="mt-3">
            <button type="button" class="btn btn-primary" onclick="prepararEEnviar()">Salvar Semana</button>
            <a href="{% url 'semanas' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<script>
    // mostra a primeira aba
    document.addEventListener("DOMContentLoaded", function(){
        const firstTab = document.querySelector('#tabs li');
        if (firstTab) firstTab.click();
    });

    function mostrarTab(diaId, el) {
        // destacar aba
        document.querySelectorAll('#tabs li').forEach(li => li.style.background = 'transparent');
        el.style.background = '#eee';

        document.querySelectorAll('.tab-content').forEach(div => div.style.display = 'none');
        const active = document.getElementById('tab-' + diaId);
        if (active) active.style.display = 'block';
    }

    function prepararEEnviar(){
        // limpa hidden fields
        const hidden = document.getElementById('hidden-fields');
        hidden.innerHTML = '';

        // agrupa checkboxes por dia
        const checkboxes = document.querySelectorAll('.musculo-checkbox');
        const map = {};
        checkboxes.forEach(cb => {
            const dia = cb.getAttribute('data-dia');
            if (!map[dia]) map[dia] = [];
            if (cb.checked) map[dia].push(cb.value);
        });

        // cria inputs hidden dia_<id> com "1,2,3"
        for (const [dia, ids] of Object.entries(map)){
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'dia_' + dia;
            input.value = ids.join(',');
            hidden.appendChild(input);
        }

        // mesmo para dias sem seleção: criar vazio (opcional)
        // você pode decidir não enviar dias vazios

        // submit
        document.getElementById('formSemana').submit();
    }
</script>
{% endblock %}
